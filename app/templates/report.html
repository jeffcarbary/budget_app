<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ğŸ“Š Budget Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <h2>ğŸ“… Week & Month Tracking  </h2>

  <section class="report-section">
    <h3>Week</h3>
    <p><strong>Total:</strong> <span id="week_total">â€“</span></p>
    <p><strong>Pace:</strong> <span id="week_pace">â€“</span></p>
    <!-- Embed the week chart from Flask route -->
    <div class="chart-container">
      <canvas id="weekChart"></canvas>
    </div>
  </section>

  <section class="report-section">
    <h3>Month</h3>
    <p><strong>Total:</strong> <span id="month_total">â€“</span></p>
    <p><strong>Week Avg:</strong> <span id="week_avg">â€“</span></p>
    <p><strong>Pace:</strong> <span id="month_pace">â€“</span></p>
    <div class="chart-container">
        <canvas id="monthChart"></canvas>
    </div>
  </section>

  <p id="msg" class="loading">Loading report...</p>
  <button onclick="window.location.href='/'">â† Back to Add Transaction</button>
  <p style="margin-top: 20px;">
    <a href="/transactions" class="link-button">ğŸ’³ View This Monthâ€™s Transactions</a>
  </p>
  <p style="text-align:center; margin-top:20px;">
  <a href="/category_trends" class="link-button">ğŸ“ˆ View Category Trends</a>
  </p>
</div>

<script>
// ===================== GLOBAL DATE CONTROL =====================
const NOW = new Date(); // or spoof date for testing: new Date("2025-11-01T12:00:00");
function today() { return new Date(NOW); }

// ===================== BUDGET HELPERS =====================
function getWeekBudget(numWeekDays) {
  return numWeekDays === 7 ? 800 : 100 * numWeekDays;
}

function getMonthBudget(todayDate = today()) {
  const daysInMonth = new Date(todayDate.getFullYear(), todayDate.getMonth() + 1, 0).getDate();
  return 800 * 4 + 100 * (daysInMonth - 28);
}

const MONTHLY_BUDGET = getMonthBudget();

// ===================== WEEKLY REPORT =====================
async function loadWeekData() {
  const res = await fetch("/reports/week");
  const data = await res.json();
  console.log("Week API data:", data);

  document.getElementById("week_total").innerText = `$${data.week_total}`;

  const projectedSpend = data.week_projected;
  console.log('-projectedSpend', projectedSpend)
  console.log('days_so_far-', data.days_so_far)
  const daysSoFar = data.days_so_far
  const WEEKLY_BUDGET = data.week_budget
  const pctOfBudget = ((projectedSpend / WEEKLY_BUDGET) * 100).toFixed(1);
  const diff = projectedSpend - WEEKLY_BUDGET;

  const paceElem = document.getElementById("week_pace");
  paceElem.innerText = `${pctOfBudget}% of $${WEEKLY_BUDGET} â€” on pace for $${projectedSpend.toFixed(0)} (${diff > 0 ? `âŒ $${diff.toFixed(0)} over` : `âœ… $${Math.abs(diff).toFixed(0)} under`})`;
  paceElem.style.color = diff > 0 ? "red" : "green";

  drawWeekChart(data);
}

// ===================== MONTHLY REPORT =====================
async function loadMonthData() {
  try {
    console.log('here')
    const res = await fetch("/reports/month");
    const data = await res.json();
    console.log('month_data', data)

    document.getElementById("month_total").innerText = `$${data.month_total}`;

    const todayDate = today();
    const dayOfMonth = todayDate.getDate();
    const daysInMonth = new Date(todayDate.getFullYear(), todayDate.getMonth()+1, 0).getDate();

    const projectedSpend = data.month_projected
    console.log('month_projected', projectedSpend)
    const pctOfBudget = data.month_pct
    const diff = data.month_diff

    const weekAvg = data.week_avg
    console.log('weekAvg', weekAvg)
    document.getElementById("week_avg").innerText = `$${weekAvg.toFixed(2)}`;

    const paceElem = document.getElementById("month_pace");
    paceElem.innerText = `${pctOfBudget}% of $${MONTHLY_BUDGET} â€” on pace for $${projectedSpend.toFixed(0)} (${diff > 0 ? `âŒ $${diff.toFixed(0)} over` : `âœ… $${Math.abs(diff).toFixed(0)} under`})`;
    paceElem.style.color = diff > 0 ? "red" : "green";

    drawMonthChart(data);
  } catch (err) {
    console.error(err);
    const msg = document.getElementById("msg");
    msg.innerText = "âŒ Failed to load monthly report";
    msg.className = "error";
  }
}

function drawMonthChart(data) {
  const ctx = document.getElementById("monthChart").getContext("2d");

  const monthStart = new Date(data.start_date);
  const numDays = data.days_in_month;
  const daysSoFar = data.days_so_far;
  const dailyTotals = data.daily_totals || {};

  // ======== Labels: 1 to numDays ========
  const labels = Array.from({ length: numDays }, (_, i) => i + 1);

  // ======== Actual Cumulative Spend ========
  let cumulative = 0;
  const actualSpend = Array.from({ length: numDays }, (_, i) => {
    const d = new Date(monthStart);
    d.setDate(monthStart.getDate() + i);
    const iso = d.toISOString().split("T")[0];
    const dailyValue = dailyTotals[iso] || 0;

    // If beyond days_so_far, donâ€™t plot
    if (i >= daysSoFar) return null;

    // If today (the last counted day) is 0, skip plotting it
    if (i === daysSoFar - 1 && dailyValue === 0) return null;

    cumulative += dailyValue;
    return cumulative;
  });

  // ======== Projected Line (from APIâ€™s projection) ========
  const avgDaily = data.month_projected / numDays;
  const projectedLine = Array.from({ length: numDays }, (_, i) => avgDaily * (i + 1));

  // ======== Weekly cumulative budget line ========
  const dailyBudget = data.month_budget / numDays;
  const budgetLine = Array.from({ length: numDays }, (_, i) => dailyBudget * (i + 1));
  const budgetLine2 = new Array(numDays).fill(data.month_budget);

  // ======== Draw Chart ========
  new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Actual Spend",
          data: actualSpend,
          borderColor: "blue",
          borderWidth: 2,
          tension: 0.3,
          fill: false,
        },
        {
          label: "Projected Spend",
          data: projectedLine,
          borderColor: "orange",
          borderDash: [5, 5],
          borderWidth: 2,
          tension: 0.3,
          fill: false,
        },
        {
          label: "Budget",
          data: budgetLine,
          borderColor: "red",
          borderDash: [2, 2],
          borderWidth: 1,
          tension: 0,
          fill: false,
        },
         {
          label: "Budget",
          data: budgetLine2,
          borderColor: "red",
          borderDash: [2, 2],
          borderWidth: 1,
          tension: 0,
          fill: false,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "Cumulative Spend ($)" },
        },
        x: {
          title: { display: true, text: "Day of Month" },
        },
      },
      plugins: { legend: { position: "bottom" } },
    },
  });
}


function parseLocalDate(dateStr) {
  const [y, m, d] = dateStr.split('-').map(Number);
  return new Date(y, m - 1, d); // JS months are 0-indexed
}

function drawWeekChart(data) {
  const ctx = document.getElementById("weekChart").getContext("2d");

  const weekStart = parseLocalDate(data.week_start);
  const numDays = data.num_week_days;
  const daysSoFar = data.days_so_far; // from API
  const todayDate = new Date(data.today);

  // ======== Labels (Friâ€“Thu, etc.) ========
  const labels = Array.from({ length: numDays }, (_, i) => {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    return d.toLocaleDateString("en-US", { weekday: "short", day: "numeric" });
  });

  // ======== Actual cumulative spend ========
  const dailyTotals = data.daily_totals || {};
  let cumulative = 0;
  console.log(daysSoFar)
  console.log(dailyTotals)
  const actualSpend = Array.from({ length: numDays }, (_, i) => {
    const d = new Date(weekStart);
    d.setDate(weekStart.getDate() + i);
    const iso = d.toISOString().split("T")[0];

    // Plot only up to days_so_far
    if (i >= daysSoFar) return null;

    cumulative += dailyTotals[iso] || 0;
    return cumulative;
  });

  // ======== Projected cumulative spend line ========
  const avgDaily = data.week_projected / numDays;
  const projectedLine = Array.from({ length: numDays }, (_, i) => avgDaily * (i + 1));

  // ======== Weekly budget line ========
  const dailyBudget = data.week_budget / numDays;
  const weeklyBudgetLine = new Array(numDays).fill(data.week_budget);
  const weeklyBudgetLine2 = Array.from({ length: numDays }, (_, i) => dailyBudget * (i + 1));

  // ======== Draw Chart ========
  new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Actual Spend",
          data: actualSpend,
          borderColor: "blue",
          borderWidth: 2,
          tension: 0.3,
          fill: false,
        },
        {
          label: "Projected Spend",
          data: projectedLine,
          borderColor: "orange",
          borderDash: [5, 5],
          borderWidth: 2,
          tension: 0.3,
          fill: false,
        },
        {
          label: "Budget",
          data: weeklyBudgetLine,
          borderColor: "red",
          borderDash: [2, 2],
          borderWidth: 1,
          tension: 0,
          fill: false,
        },
         {
          label: "Budget",
          data: weeklyBudgetLine2,
          borderColor: "red",
          borderDash: [2, 2],
          borderWidth: 1,
          tension: 0,
          fill: false,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: "Cumulative Spend ($)" },
        },
        x: {
          title: { display: true, text: "Day of Week" },
        },
      },
      plugins: { legend: { position: "bottom" } },
    },
  });
}

// ===================== INIT =====================
document.addEventListener("DOMContentLoaded", () => {
  Promise.all([loadWeekData(), loadMonthData()])
    .then(() => {
      const msg = document.getElementById("msg");
      msg.innerText = "âœ… Loaded successfully";
      msg.className = "success";
    })
    .catch(() => {
      const msg = document.getElementById("msg");
      msg.innerText = "âŒ Failed to load one or more reports";
      msg.className = "error";
    });
});
</script>
</body>
</html>
