<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='nutrition.css') }}">
    <title>Nutrition Log - {{ user.username }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/nutrition_chart.js') }}"></script>
</head>
<body>
<div class="main-container">

    <h3>{{ user.username|capitalize }}'s Nutrition Log</h3>

    <!-- Date Picker -->
    <form method="GET" action="{{ url_for('nutrition.index', username=user.username) }}" style="margin-bottom:20px;">
        <label for="log_date">Choose a day:</label>
        <input type="date" id="log_date" name="log_date" value="{{ selected_date }}">
        <button type="submit">Go</button>
    </form>

    <a href="{{ url_for('nutrition.add_entry', username=user.username) }}" class="btn-add-entry">Add New Entry</a>

    <!-- Top Panel -->
    <div class="nutrition-summary">
        <p>Calories: {{ calendar_total_calories|int }} / {{ calories.current_target }}</p>
        <p style="color: {{ 'red' if calories.current_deficit < 0 else 'green' }};">
            {{ cal_deficit|int }} kcal
            {% if calories.current_deficit < 0 %}
                &#x25BC;
                {{ calories.target_catchup_time.strftime("%H:%M") if calories.target_catchup_time else "" }}
            {% else %}
                &#x25B2;
            {% endif %}
        </p>
        <p>Protein: {{ calendar_total_protein|int }}g</p>
        <p>Fiber: {{ calendar_total_fiber|int }}g</p>
    </div>

    <!-- Calories Chart -->
    <div class="chart-container">
        <canvas id="calorieChart"></canvas>
    </div>

    <!-- Entries Table -->
    <div class="table-container">
        <table>
            <thead>
                <tr><th></th><th></th><th></th></tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td>{{ entry.timestamp.strftime('%H:%M') }}</td>
                    <td>{{ entry.food.name[:20] }}</td>
                    <td>{{ entry.calories|int }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="text-align: right; margin-top: 8px;">
            <a href="{{ url_for('nutrition.delete_entries', username=user.username) }}" class="btn-delete-entry">
                Edit / Delete Entries
            </a>
        </div>
    </div>

    <!-- Protein & Fiber Charts -->
    <div class="chart-container">
        <canvas id="proteinChart"></canvas>
    </div>

    <div class="chart-container">
        <canvas id="fiberChart"></canvas>
    </div>

    <a href="{{ url_for('nutrition.reports', username=user.username) }}" class="btn-reports">Reports</a>
    <a href="{{ url_for('nutrition.settings', username=user.username) }}" class="btn-settings">User Settings</a>
    <br><br><br>

    <!-- Chart Data for JS -->
    <script>
        const chartData = {
            labels: {{ chart_labels|tojson }},
            actual: {{ calories.actual|tojson }},
            target: {{ calories.target|tojson }},
            projected: {{ calories.projected|tojson }},
            yesterday: {{ yesterday_calories.actual|tojson }}
        };
        const proteinData = {
            labels: {{ chart_labels|tojson }},
            actual: {{ protein.actual|tojson }},
            target: {{ protein.target|tojson }},
            projected: {{ protein.projected|tojson }},
            yesterday: {{ yesterday_protein.actual|tojson }}
        };
        const fiberData = {
            labels: {{ chart_labels|tojson }},
            actual: {{ fiber.actual|tojson }},
            target: {{ fiber.target|tojson }},
            projected: {{ fiber.projected|tojson }},
            yesterday: {{ yesterday_fiber.actual|tojson }}
        };
    </script>
</div>
</body>
</html>

